name: Reusable - Pending Jobs Kanban

on:
  workflow_call: {}

jobs:
  build-kanban:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Generate Kanban View
        uses: actions/github-script@v7
        with:
          # Use the runtime token available in workflow context
          github-token: ${{ github.token }}
          script: |
            (async () => {
              try {
                const { data: issues } = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  per_page: 100
                });

                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const endOfWeek = new Date(today);
                endOfWeek.setDate(today.getDate() + 7);

                const groups = {
                  "ðŸŸ¥ Over-Due": [],
                  "ðŸŸ§ Due-Today": [],
                  "ðŸŸ¨ Due-This Week": [],
                  "ðŸŸ© Due-Upcoming Weeks": []
                };

                for (const issue of issues) {
                  const match = issue.body?.match(/Due Date:\s*(\d{4}-\d{2}-\d{2})/);
                  if (!match) continue;

                  const dueStr = match[1];
                  const dueDate = new Date(dueStr);

                  if (dueDate < today) {
                    groups["ðŸŸ¥ Over-Due"].push({ number: issue.number, title: issue.title, due: dueStr });
                  } else if (dueDate.toDateString() === today.toDateString()) {
                    groups["ðŸŸ§ Due-Today"].push({ number: issue.number, title: issue.title, due: dueStr });
                  } else if (dueDate > today && dueDate <= endOfWeek) {
                    groups["ðŸŸ¨ Due-This Week"].push({ number: issue.number, title: issue.title, due: dueStr });
                  } else {
                    groups["ðŸŸ© Due-Upcoming Weeks"].push({ number: issue.number, title: issue.title, due: dueStr });
                  }
                }

                const makeList = (arr) => {
                  if (!arr.length) return "_No issues_";
                  return arr.map(i => `- #${i.number} **${i.title}** (Due: ${i.due})`).join("\n");
                };

                const kanban = [
                  `### ðŸ—“ï¸ Pending Jobs Kanban View (Updated: ${new Date().toLocaleString()})`,
                  "",
                  "**ðŸŸ¥ Over-Due**",
                  makeList(groups["ðŸŸ¥ Over-Due"]),
                  "",
                  "**ðŸŸ§ Due-Today**",
                  makeList(groups["ðŸŸ§ Due-Today"]),
                  "",
                  "**ðŸŸ¨ Due-This Week**",
                  makeList(groups["ðŸŸ¨ Due-This Week"]),
                  "",
                  "**ðŸŸ© Due-Upcoming Weeks**",
                  makeList(groups["ðŸŸ© Due-Upcoming Weeks"])
                ].join("\n");

                const issueTitle = "ðŸ“‹ Pending Jobs Kanban View";

                const { data: openIssues } = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  per_page: 100
                });

                let tracker = openIssues.find(i => i.title === issueTitle);

                if (tracker) {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: tracker.number,
                    body: kanban
                  });
                  console.log(`Updated existing Kanban issue #${tracker.number}`);
                } else {
                  const { data: newIssue } = await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: issueTitle,
                    body: kanban
                  });
                  console.log(`Created new Kanban issue #${newIssue.number}`);
                }
              } catch (error) {
                core.setFailed(`Kanban generation failed: ${error.message}`);
              }
            })();
