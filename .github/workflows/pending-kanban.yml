name: Pending Jobs Kanban Generator

on:
  workflow_call:

permissions:
  issues: write
  contents: read

jobs:
  pending-kanban:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (gh, jq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh jq

      - name: Generate Pending Jobs Kanban View
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          echo "üîç Determining owner and repo..."
          # GITHUB_REPOSITORY format is "owner/repo"
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY##*/}"
          echo "Owner: $OWNER  Repo: $REPO"

          echo "üîç Fetching open issues (number, title, body, milestone)..."
          issues_json=$(gh issue list --repo "$OWNER/$REPO" --state open --limit 100 --json number,title,body,milestone)

          # prepare containers
          overdue=""
          due_today=""
          due_week=""
          upcoming=""

          # compute date boundaries in UTC YYYY-MM-DD
          today=$(date -u +"%Y-%m-%d")
          # end of week: 7 days from today (inclusive)
          week_end=$(date -u -d "$today +7 days" +"%Y-%m-%d")

          echo "Today (UTC): $today"
          echo "Week end (UTC): $week_end"

          # iterate issues
          echo "$issues_json" | jq -c '.[]' | while read -r issue; do
            num=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')

            # Try milestone.due_on first (ISO 8601), then look for "Due" marker in body like "Due: 2025-11-01" or "Due Date: 2025-11-01"
            due=$(echo "$issue" | jq -r '.milestone.due_on // empty')
            if [ -z "$due" ]; then
              # extract first YYYY-MM-DD in body after a "Due" or "Due Date" label (case-insensitive)
              body=$(echo "$issue" | jq -r '.body // empty')
              due=$(echo "$body" | grep -ioE "Due Date[: ]+[0-9]{4}-[0-9]{2}-[0-9]{2}" | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -1 || true)
              if [ -z "$due" ]; then
                due=$(echo "$body" | grep -ioE "Due[: ]+[0-9]{4}-[0-9]{2}-[0-9]{2}" | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -1 || true)
              fi
            fi

            # normalize due date to YYYY-MM-DD (strip time if present)
            if [ -n "$due" ]; then
              # if due contains time part (e.g., 2025-11-01T00:00:00Z), extract date part
              due_date=$(echo "$due" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')
            else
              due_date=""
            fi

            if [ -n "$due_date" ]; then
              if [[ "$due_date" < "$today" ]]; then
                overdue+=$'\n'"- #$num $title (Due: $due_date)"
              elif [[ "$due_date" == "$today" ]]; then
                due_today+=$'\n'"- #$num $title (Due: $due_date)"
              elif [[ "$due_date" > "$today" && "$due_date" <= "$week_end" ]]; then
                due_week+=$'\n'"- #$num $title (Due: $due_date)"
              else
                upcoming+=$'\n'"- #$num $title (Due: $due_date)"
              fi
            fi
          done

          # build kanban body
          KANBAN=$(cat <<EOF
### üóìÔ∏è Pending Jobs Kanban View (Updated: $(date -u +"%Y-%m-%d %H:%M UTC"))

**üü• Over-Due**
${overdue:-_No overdue issues_}

**üüß Due Today**
${due_today:-_No issues due today_}

**üü® Due This Week**
${due_week:-_No issues due this week_}

**üü© Due Upcoming Weeks**
${upcoming:-_No upcoming issues_}
EOF
)

          echo "üìù Kanban content prepared:"
          echo "---------------------------------"
          echo "$KANBAN"
          echo "---------------------------------"

          # find existing tracker issue by exact title
          existing_issue_number=$(gh issue list --repo "$OWNER/$REPO" --state open --search "üìã Pending Jobs Kanban View" --json number --jq '.[0].number' 2>/dev/null || true)

          if [ -z "$existing_issue_number" ] || [ "$existing_issue_number" = "null" ]; then
            echo "Creating new issue 'üìã Pending Jobs Kanban View'..."
            gh issue create --repo "$OWNER/$REPO" --title "üìã Pending Jobs Kanban View" --body "$KANBAN" --label "kanban-view" || true
            echo "‚úÖ Created new Kanban issue."
          else
            echo "Updating existing Kanban issue #$existing_issue_number..."
            gh issue edit "$existing_issue_number" --repo "$OWNER/$REPO" --body "$KANBAN" || true
            echo "üîÅ Updated Kanban issue #$existing_issue_number."
          fi
