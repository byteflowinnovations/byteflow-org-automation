name: Pending Jobs Kanban Generator

on:
  workflow_call:

jobs:
  pending-kanban:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Generate Pending Jobs Kanban View
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Fetching issues with due dates..."
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          # Get all open issues with due dates (milestone due_on or field name "Due Date")
          issues=$(gh issue list --repo "$OWNER/$REPO" --state open --json number,title,body,labels,milestone,createdAt)

          today=$(date -u +"%Y-%m-%d")
          this_week_end=$(date -u -d "next Sunday" +"%Y-%m-%d")

          overdue=""
          due_today=""
          due_week=""
          upcoming=""

          # Parse each issue
          echo "$issues" | jq -c '.[]' | while read -r issue; do
            num=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')

            # Attempt to extract due date (from milestone or body tag "Due:")
            due=$(echo "$issue" | jq -r '.milestone.due_on // empty')
            if [ -z "$due" ]; then
              due=$(echo "$issue" | grep -oE "Due[: ]+[0-9]{4}-[0-9]{2}-[0-9]{2}" | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -1)
            fi

            if [ -n "$due" ]; then
              if [[ "$due" < "$today" ]]; then
                overdue+="\n- #$num $title (Due: $due)"
              elif [[ "$due" == "$today" ]]; then
                due_today+="\n- #$num $title (Due: $due)"
              elif [[ "$due" < "$this_week_end" ]]; then
                due_week+="\n- #$num $title (Due: $due)"
              else
                upcoming+="\n- #$num $title (Due: $due)"
              fi
            fi
          done

          KANBAN="### üü• Over-Due
${overdue:-_No overdue issues_}

### üüß Due Today
${due_today:-_No issues due today_}

### üü® Due This Week
${due_week:-_No issues due this week_}

### üü© Due Upcoming Weeks
${upcoming:-_No upcoming issues_}
"

          echo "üìù Creating or updating Kanban issue..."
          issue_number=$(gh issue list --repo "$OWNER/$REPO" --search "Pending Jobs Kanban View" --json number --jq ".[0].number")

          if [ -z "$issue_number" ]; then
            gh issue create --repo "$OWNER/$REPO" --title "üìã Pending Jobs Kanban View" --body "$KANBAN" --label "kanban-view"
            echo "‚úÖ Created new Kanban issue."
          else
            gh issue edit "$issue_number" --repo "$OWNER/$REPO" --body "$KANBAN"
            echo "üîÅ Updated existing Kanban issue #$issue_number."
          fi
