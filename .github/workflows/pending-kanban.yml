name: Pending Jobs Kanban Generator

on:
  workflow_call:

permissions:
  issues: write
  contents: read

jobs:
  pending-kanban:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install gh and jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh jq

      - name: Generate Pending Jobs Kanban View
        env:
          GITHUB_TOKEN: ${{ github.token }}
          TZ: UTC
        run: |
          set -euo pipefail

          echo "üîç Determine owner and repo..."
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY##*/}"
          echo "Owner: $OWNER  Repo: $REPO"

          echo "üîç Fetching open issues..."
          issues_json=$(gh issue list --repo "$OWNER/$REPO" --state open --limit 100 --json number,title,body,milestone)

          # Prepare containers
          OVERDUE=""
          DUE_TODAY=""
          DUE_WEEK=""
          UPCOMING=""

          # Dates (UTC, YYYY-MM-DD)
          TODAY=$(date -u +"%Y-%m-%d")
          WEEK_END=$(date -u -d "$TODAY +7 days" +"%Y-%m-%d")

          echo "Today (UTC): $TODAY"
          echo "Week end (UTC): $WEEK_END"

          # Iterate issues and extract due date (milestone.due_on or body "Due" / "Due Date")
          echo "$issues_json" | jq -c '.[]' | while read -r issue; do
            num=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title' | sed 's/"/\\"/g')

            # try milestone.due_on first
            due_iso=$(echo "$issue" | jq -r '.milestone.due_on // empty')
            if [ -z "$due_iso" ]; then
              body=$(echo "$issue" | jq -r '.body // empty')
              # find first YYYY-MM-DD after "Due" or "Due Date" (case-insensitive)
              due_iso=$(echo "$body" | grep -ioE "Due Date[: ]+[0-9]{4}-[0-9]{2}-[0-9]{2}" | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -1 || true)
              if [ -z "$due_iso" ]; then
                due_iso=$(echo "$body" | grep -ioE "Due[: ]+[0-9]{4}-[0-9]{2}-[0-9]{2}" | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -1 || true)
              fi
            fi

            # normalize to YYYY-MM-DD
            if [ -n "$due_iso" ]; then
              due_date=$(echo "$due_iso" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')
            else
              due_date=""
            fi

            if [ -n "$due_date" ]; then
              if [[ "$due_date" < "$TODAY" ]]; then
                OVERDUE+=$'\n'"- #$num $title (Due: $due_date)"
              elif [[ "$due_date" == "$TODAY" ]]; then
                DUE_TODAY+=$'\n'"- #$num $title (Due: $due_date)"
              elif [[ "$due_date" > "$TODAY" && "$due_date" <= "$WEEK_END" ]]; then
                DUE_WEEK+=$'\n'"- #$num $title (Due: $due_date)"
              else
                UPCOMING+=$'\n'"- #$num $title (Due: $due_date)"
              fi
            fi
          done

          # Build kanban body safely using a quoted heredoc
          read -r -d '' KANBAN <<'KAN'
### üóìÔ∏è Pending Jobs Kanban View (Updated: __UPDATED_AT__)
**üü• Over-Due**
__OVERDUE__

**üüß Due Today**
__DUE_TODAY__

**üü® Due This Week**
__DUE_WEEK__

**üü© Due Upcoming Weeks**
__UPCOMING__
KAN

          # Replace placeholders
          UPDATED_AT="$(date -u +"%Y-%m-%d %H:%M UTC")"
          KAN=${KAN//'__UPDATED_AT__'/"$UPDATED_AT"}
          OVERDUE_CONTENT="${OVERDUE:-_No overdue issues_}"
          DUE_TODAY_CONTENT="${DUE_TODAY:-_No issues due today_}"
          DUE_WEEK_CONTENT="${DUE_WEEK:-_No issues due this week_}"
          UPCOMING_CONTENT="${UPCOMING:-_No upcoming issues_}"

          KAN="${KAN//'__OVERDUE__'/"$OVERDUE_CONTENT"}"
          KAN="${KAN//'__DUE_TODAY__'/"$DUE_TODAY_CONTENT"}"
          KAN="${KAN//'__DUE_WEEK__'/"$DUE_WEEK_CONTENT"}"
          KAN="${KAN//'__UPCOMING__'/"$UPCOMING_CONTENT"}"

          echo "----- Kanban body -----"
          echo "$KAN"
          echo "-----------------------"

          # Find existing tracker issue by exact title
          existing_issue_number=$(gh issue list --repo "$OWNER/$REPO" --state open --search "üìã Pending Jobs Kanban View" --json number --jq '.[0].number' 2>/dev/null || true)

          if [ -z "$existing_issue_number" ] || [ "$existing_issue_number" = "null" ]; then
            echo "Creating new issue 'üìã Pending Jobs Kanban View'..."
            gh issue create --repo "$OWNER/$REPO" --title "üìã Pending Jobs Kanban View" --body "$KAN" --label "kanban-view" || true
            echo "‚úÖ Created new Kanban issue."
          else
            echo "Updating existing Kanban issue #$existing_issue_number..."
            gh issue edit "$existing_issue_number" --repo "$OWNER/$REPO" --body "$KAN" || true
            echo "üîÅ Updated Kanban issue #$existing_issue_number."
          fi
